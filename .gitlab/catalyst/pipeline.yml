################################################################################
## Copyright (c) 2014-2021, Lawrence Livermore National Security, LLC.
## Produced at the Lawrence Livermore National Laboratory.
## Written by the LBANN Research Team (B. Van Essen, et al.) listed in
## the CONTRIBUTORS file. <lbann-dev@llnl.gov>
##
## LLNL-CODE-697807.
## All rights reserved.
##
## This file is part of LBANN: Livermore Big Artificial Neural Network
## Toolkit. For details, see http://software.llnl.gov/LBANN or
## https://github.com/LLNL/LBANN.
##
## Licensed under the Apache License, Version 2.0 (the "Licensee"); you
## may not use this file except in compliance with the License.  You may
## obtain a copy of the License at:
##
## http://www.apache.org/licenses/LICENSE-2.0
##
## Unless required by applicable law or agreed to in writing, software
## distributed under the License is distributed on an "AS IS" BASIS,
## WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
## implied. See the License for the specific language governing
## permissions and limitations under the license.
################################################################################

# This is the testing pipeline for the Catalyst cluster at LLNL. This
# cluster builds the LBANN applications and libraries using a single
# compiler toolchain and then runs a collection of tests. Testing
# output is in JUnit format and parsed by the pipeline for web
# viewing.

stages:
  - allocate
  - build
  # - test
  - deallocate

allocate lc resources:
  stage: allocate
  extends: .catalyst common
  variables:
    GIT_STRATEGY: none
  script:
    - echo "== ACQUIRING SLURM RESOURCES =="
    - salloc --exclusive -N 1 -p pdebug -t 120 --no-shell -J ${JOB_NAME}
  timeout: 6h

build and install:
  extends:
    - .uses spack
    - .catalyst common
  stage: build
  artifacts:
    paths:
      - spack-*.txt
      - spack-build-*/CMakeCache.txt
      - spack-build-*/build.ninja
      - spack-build-*/spack-*.txt
  script:
    - echo "== BUILDING LBANN =="
    - export JOB_ID=$(squeue -h -n "${JOB_NAME}" -o "%A")
    - export BUILD_TASKS=$(($(nproc) + 2))
    - source ${HOME}/spack_repos/spack_${SYSTEM_NAME}.git/share/spack/setup-env.sh
    - spack env
    - srun --jobid=${JOB_ID} -N 1 -t 120 ./scripts/build_lbann.sh -d
      -l ${SPACK_ENV_NAME} --test --clean-build -j ${BUILD_TASKS} --
      +deterministic +vision +numpy ${SPACK_SPECS}

# This handles the call to
unit tests:
  extends:
    - .catalyst common
    - .uses spack environment
  stage: test
  dependencies:
    - build and install
  script:
    - echo "== RUNNING PYTHON-BASED UNIT TESTS =="
    - echo "Testing $(which lbann)"

# run_tests:
#   extends:
#     - .uses spack
#     - .catalyst common
#   stage: test
#   dependencies:
#     - build_lib_and_tests
#   script:
#     - echo "== RUNNING TESTS =="
#     - export JOB_ID=$(squeue -h -n "${JOB_NAME}" -o "%A")
#     - srun --jobid=${JOB_ID} -N 1 -n 1 -t 5 .gitlab/${SYSTEM_NAME}/test.sh
#   artifacts:
#     when: always
#     # paths:
#     #   - unittest-junit-${SYSTEM_NAME}.xml
#     reports:
#       junit: unittest-junit-${SYSTEM_NAME}.xml

remove spack environment:
  extends: .catalyst common
  stage: deallocate
  when: always
  script:
    - source ${HOME}/spack_repos/spack_${SYSTEM_NAME}.git/share/spack/setup-env.sh
    - export SPACK_ARCH_TARGET=$(spack arch -t)
    - export FULL_ENV_NAME=lbann-${SPACK_ENV_NAME}-${SPACK_ARCH_TARGET}
    - |
      if [[ -n "$(spack env list | grep -e ${FULL_ENV_NAME})" ]] ;
      then
        spack env rm ${FULL_ENV_NAME}
      fi

release allocation:
  stage: deallocate
  extends: .catalyst common
  variables:
    GIT_STRATEGY: none
  when: always
  script:
    - echo "== RELEASING RESOURCES =="
    - export JOB_ID=$(squeue -h -n "${JOB_NAME}" -o "%A")
    - ([ -n "${JOB_ID}" ] && scancel ${JOB_ID})

# This should be extended by any job that needs the spack repository
# access.
.uses spack:
  before_script:
    - source ${HOME}/spack_repos/spack_catalyst.git/share/spack/setup-env.sh

# This loads the spack shell integration (via ".uses spack") and
# then loads the environment. This should only be used after the
# build stage (i.e., in testing).
.uses spack environment:
  before_script:
    - source ${HOME}/spack_repos/spack_catalyst.git/share/spack/setup-env.sh

.catalyst common:
  variables:
    # Just the obvious identifier. Which specific node doesn't matter.
    SYSTEM_NAME: catalyst

    # This is based on the assumption that each runner will only ever
    # be able to run one pipeline on a given cluster at one time.
    SPACK_ENV_NAME: gitlab-${CI_PIPELINE_ID}

    # These are system-specific specs that should be forwarded to the
    # build script
    SPACK_SPECS: "+onednn +half +fft"

    # This variable is the name used to identify the job in the Slurm
    # queue. We need this to be able to access the correct jobid.
    JOB_NAME: ${CI_PROJECT_NAME}_${CI_PIPELINE_ID}

    # This is needed to ensure that we run as lbannusr.
    LLNL_SERVICE_USER: lbannusr
  tags:
    - catalyst
    - shell
