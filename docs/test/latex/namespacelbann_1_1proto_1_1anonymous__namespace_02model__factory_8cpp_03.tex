\hypertarget{namespacelbann_1_1proto_1_1anonymous__namespace_02model__factory_8cpp_03}{}\section{lbann\+:\+:proto\+:\+:anonymous\+\_\+namespace\{model\+\_\+factory.\+cpp\} Namespace Reference}
\label{namespacelbann_1_1proto_1_1anonymous__namespace_02model__factory_8cpp_03}\index{lbann\+::proto\+::anonymous\+\_\+namespace\lcurly{}model\+\_\+factory.\+cpp\rcurly{}@{lbann\+::proto\+::anonymous\+\_\+namespace\lcurly{}model\+\_\+factory.\+cpp\rcurly{}}}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classlbann_1_1model}{model} $\ast$ \hyperlink{namespacelbann_1_1proto_1_1anonymous__namespace_02model__factory_8cpp_03_a6a08f0b26d015824ef28ddbb66b6d4c0}{instantiate\+\_\+model} (\hyperlink{classlbann_1_1lbann__comm}{lbann\+\_\+comm} $\ast$\hyperlink{file__io_8cpp_ab048c6f9fcbcfaa57ce68b00263dbebe}{comm}, \hyperlink{classlbann_1_1objective__function}{objective\+\_\+function} $\ast$obj, const lbann\+\_\+data\+::\+Optimizer \&proto\+\_\+opt, const lbann\+\_\+data\+::\+Model \&proto\+\_\+model)
\item 
void \hyperlink{namespacelbann_1_1proto_1_1anonymous__namespace_02model__factory_8cpp_03_a3406a809935f319486cf8fd017b58417}{assign\+\_\+layers\+\_\+to\+\_\+objective\+\_\+function} (std\+::vector$<$ \hyperlink{classlbann_1_1Layer}{Layer} $\ast$$>$ \&layer\+\_\+list, \hyperlink{classlbann_1_1objective__function}{objective\+\_\+function} $\ast$obj, const lbann\+\_\+data\+::\+Objective\+Function \&proto\+\_\+obj)
\item 
void \hyperlink{namespacelbann_1_1proto_1_1anonymous__namespace_02model__factory_8cpp_03_a19d0eaf0259647155039ed45eb980b05}{assign\+\_\+weights\+\_\+to\+\_\+layers} (std\+::vector$<$ \hyperlink{classlbann_1_1Layer}{Layer} $\ast$$>$ \&layer\+\_\+list, std\+::vector$<$ \hyperlink{classlbann_1_1weights}{weights} $\ast$$>$ \&weights\+\_\+list, const lbann\+\_\+data\+::\+Model \&proto\+\_\+model)
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\mbox{\Hypertarget{namespacelbann_1_1proto_1_1anonymous__namespace_02model__factory_8cpp_03_a3406a809935f319486cf8fd017b58417}\label{namespacelbann_1_1proto_1_1anonymous__namespace_02model__factory_8cpp_03_a3406a809935f319486cf8fd017b58417}} 
\index{lbann\+::proto\+::anonymous\+\_\+namespace\lcurly{}model\+\_\+factory.\+cpp\rcurly{}@{lbann\+::proto\+::anonymous\+\_\+namespace\lcurly{}model\+\_\+factory.\+cpp\rcurly{}}!assign\+\_\+layers\+\_\+to\+\_\+objective\+\_\+function@{assign\+\_\+layers\+\_\+to\+\_\+objective\+\_\+function}}
\index{assign\+\_\+layers\+\_\+to\+\_\+objective\+\_\+function@{assign\+\_\+layers\+\_\+to\+\_\+objective\+\_\+function}!lbann\+::proto\+::anonymous\+\_\+namespace\lcurly{}model\+\_\+factory.\+cpp\rcurly{}@{lbann\+::proto\+::anonymous\+\_\+namespace\lcurly{}model\+\_\+factory.\+cpp\rcurly{}}}
\subsubsection{\texorpdfstring{assign\+\_\+layers\+\_\+to\+\_\+objective\+\_\+function()}{assign\_layers\_to\_objective\_function()}}
{\footnotesize\ttfamily void lbann\+::proto\+::anonymous\+\_\+namespace\{model\+\_\+factory.\+cpp\}\+::assign\+\_\+layers\+\_\+to\+\_\+objective\+\_\+function (\begin{DoxyParamCaption}\item[{std\+::vector$<$ \hyperlink{classlbann_1_1Layer}{Layer} $\ast$$>$ \&}]{layer\+\_\+list,  }\item[{\hyperlink{classlbann_1_1objective__function}{objective\+\_\+function} $\ast$}]{obj,  }\item[{const lbann\+\_\+data\+::\+Objective\+Function \&}]{proto\+\_\+obj }\end{DoxyParamCaption})}



Definition at line 78 of file model\+\_\+factory.\+cpp.


\begin{DoxyCode}
80                                                                                        \{
81   std::stringstream err;
82 
83   \textcolor{comment}{// Construct map from layer names to layers}
84   std::unordered\_map<std::string, Layer*> names\_to\_layers;
85   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto}&& l : layer\_list) \{
86     \textcolor{keyword}{const} \textcolor{keyword}{auto}& name = l->get\_name();
87     \textcolor{keywordflow}{if} (names\_to\_layers.count(name) > 0) \{
88       err << \textcolor{stringliteral}{"layer name \(\backslash\)""} << name << \textcolor{stringliteral}{"\(\backslash\)" is not unique"};
89       \hyperlink{base_8hpp_a80b1d707117e968a6951b7222e4b2b87}{LBANN\_ERROR}(err.str());
90     \}
91     names\_to\_layers[name] = l;
92   \}
93 
94   \textcolor{comment}{// Assign evaluation layers to layer terms in objective function}
95   \textcolor{keyword}{auto}&& obj\_terms = obj->get\_terms();
96   \textcolor{keywordtype}{int} num\_layer\_terms = 0;
97   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} i = 0; i < obj\_terms.size(); ++i) \{
98     \textcolor{keyword}{auto}&& term = \textcolor{keyword}{dynamic\_cast<}layer\_term*\textcolor{keyword}{>}(obj\_terms[i]);
99     \textcolor{keywordflow}{if} (term != \textcolor{keyword}{nullptr}) \{
100       ++num\_layer\_terms;
101       \textcolor{keywordflow}{if} (num\_layer\_terms > proto\_obj.layer\_term\_size()) \{ \textcolor{keywordflow}{continue}; \}
102       \textcolor{keyword}{const} \textcolor{keyword}{auto}& params = proto\_obj.layer\_term(num\_layer\_terms-1);
103       \textcolor{keyword}{auto}&& eval = names\_to\_layers[params.layer()];
104       term->set\_evaluation\_layer(eval);
105     \}
106   \}
107 
108   \textcolor{comment}{// Check that layer terms in objective function match prototext}
109   \textcolor{keywordflow}{if} (num\_layer\_terms != proto\_obj.layer\_term\_size()) \{
110     err << \textcolor{stringliteral}{"number of layer terms in objective function does not match prototext "}
111         << \textcolor{stringliteral}{"(expected "} << proto\_obj.layer\_term\_size() << \textcolor{stringliteral}{", "}
112         << \textcolor{stringliteral}{"found "} << num\_layer\_terms << \textcolor{stringliteral}{")"};
113     \hyperlink{base_8hpp_a80b1d707117e968a6951b7222e4b2b87}{LBANN\_ERROR}(err.str());
114   \}
115   
116 \}
\end{DoxyCode}
Here is the call graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacelbann_1_1proto_1_1anonymous__namespace_02model__factory_8cpp_03_a3406a809935f319486cf8fd017b58417_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacelbann_1_1proto_1_1anonymous__namespace_02model__factory_8cpp_03_a3406a809935f319486cf8fd017b58417_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{namespacelbann_1_1proto_1_1anonymous__namespace_02model__factory_8cpp_03_a19d0eaf0259647155039ed45eb980b05}\label{namespacelbann_1_1proto_1_1anonymous__namespace_02model__factory_8cpp_03_a19d0eaf0259647155039ed45eb980b05}} 
\index{lbann\+::proto\+::anonymous\+\_\+namespace\lcurly{}model\+\_\+factory.\+cpp\rcurly{}@{lbann\+::proto\+::anonymous\+\_\+namespace\lcurly{}model\+\_\+factory.\+cpp\rcurly{}}!assign\+\_\+weights\+\_\+to\+\_\+layers@{assign\+\_\+weights\+\_\+to\+\_\+layers}}
\index{assign\+\_\+weights\+\_\+to\+\_\+layers@{assign\+\_\+weights\+\_\+to\+\_\+layers}!lbann\+::proto\+::anonymous\+\_\+namespace\lcurly{}model\+\_\+factory.\+cpp\rcurly{}@{lbann\+::proto\+::anonymous\+\_\+namespace\lcurly{}model\+\_\+factory.\+cpp\rcurly{}}}
\subsubsection{\texorpdfstring{assign\+\_\+weights\+\_\+to\+\_\+layers()}{assign\_weights\_to\_layers()}}
{\footnotesize\ttfamily void lbann\+::proto\+::anonymous\+\_\+namespace\{model\+\_\+factory.\+cpp\}\+::assign\+\_\+weights\+\_\+to\+\_\+layers (\begin{DoxyParamCaption}\item[{std\+::vector$<$ \hyperlink{classlbann_1_1Layer}{Layer} $\ast$$>$ \&}]{layer\+\_\+list,  }\item[{std\+::vector$<$ \hyperlink{classlbann_1_1weights}{weights} $\ast$$>$ \&}]{weights\+\_\+list,  }\item[{const lbann\+\_\+data\+::\+Model \&}]{proto\+\_\+model }\end{DoxyParamCaption})}

Setup pointers from layers to weights. 

Definition at line 119 of file model\+\_\+factory.\+cpp.


\begin{DoxyCode}
121                                                                   \{
122   std::stringstream err;
123 
124   \textcolor{comment}{// Construct map from weights names to weights}
125   std::unordered\_map<std::string, weights*> names\_to\_weights;
126   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto}&& w : weights\_list) \{
127     \textcolor{keyword}{const} \textcolor{keyword}{auto}& name = w->get\_name();
128     \textcolor{keywordflow}{if} (names\_to\_weights.count(name) > 0) \{
129       err << \textcolor{stringliteral}{"weights name \(\backslash\)""} << name << \textcolor{stringliteral}{"\(\backslash\)" is not unique"};
130       \hyperlink{base_8hpp_a80b1d707117e968a6951b7222e4b2b87}{LBANN\_ERROR}(err.str());
131     \}
132     names\_to\_weights[name] = w;
133   \}
134 
135   \textcolor{comment}{// Find weights assigned to each layer}
136   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i=0; i<proto\_model.layer\_size(); ++i) \{
137     \textcolor{keyword}{const} \textcolor{keyword}{auto}& proto\_layer = proto\_model.layer(i);
138     \textcolor{keyword}{auto}& layer\_weights = layer\_list[i]->get\_weights();
139     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto}&& name : parse\_list<std::string>(proto\_layer.weights())) \{
140       \textcolor{keyword}{auto}&& w = names\_to\_weights[name];
141       \textcolor{keywordflow}{if} (w == \textcolor{keyword}{nullptr}) \{
142         err << \textcolor{stringliteral}{"could not find weights named \(\backslash\)""} << name << \textcolor{stringliteral}{"\(\backslash\)", "}
143             << \textcolor{stringliteral}{"which are expected by layer "} << layer\_list[i]->get\_name();
144         \hyperlink{base_8hpp_a80b1d707117e968a6951b7222e4b2b87}{LBANN\_ERROR}(err.str());
145       \}
146       layer\_weights.push\_back(w);
147     \}
148   \}  
149 
150 \}
\end{DoxyCode}
Here is the caller graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacelbann_1_1proto_1_1anonymous__namespace_02model__factory_8cpp_03_a19d0eaf0259647155039ed45eb980b05_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{namespacelbann_1_1proto_1_1anonymous__namespace_02model__factory_8cpp_03_a6a08f0b26d015824ef28ddbb66b6d4c0}\label{namespacelbann_1_1proto_1_1anonymous__namespace_02model__factory_8cpp_03_a6a08f0b26d015824ef28ddbb66b6d4c0}} 
\index{lbann\+::proto\+::anonymous\+\_\+namespace\lcurly{}model\+\_\+factory.\+cpp\rcurly{}@{lbann\+::proto\+::anonymous\+\_\+namespace\lcurly{}model\+\_\+factory.\+cpp\rcurly{}}!instantiate\+\_\+model@{instantiate\+\_\+model}}
\index{instantiate\+\_\+model@{instantiate\+\_\+model}!lbann\+::proto\+::anonymous\+\_\+namespace\lcurly{}model\+\_\+factory.\+cpp\rcurly{}@{lbann\+::proto\+::anonymous\+\_\+namespace\lcurly{}model\+\_\+factory.\+cpp\rcurly{}}}
\subsubsection{\texorpdfstring{instantiate\+\_\+model()}{instantiate\_model()}}
{\footnotesize\ttfamily \hyperlink{classlbann_1_1model}{model}$\ast$ lbann\+::proto\+::anonymous\+\_\+namespace\{model\+\_\+factory.\+cpp\}\+::instantiate\+\_\+model (\begin{DoxyParamCaption}\item[{\hyperlink{classlbann_1_1lbann__comm}{lbann\+\_\+comm} $\ast$}]{comm,  }\item[{\hyperlink{classlbann_1_1objective__function}{objective\+\_\+function} $\ast$}]{obj,  }\item[{const lbann\+\_\+data\+::\+Optimizer \&}]{proto\+\_\+opt,  }\item[{const lbann\+\_\+data\+::\+Model \&}]{proto\+\_\+model }\end{DoxyParamCaption})}

Instantiate a model based on prototext. 

Definition at line 36 of file model\+\_\+factory.\+cpp.


\begin{DoxyCode}
39                                                              \{
40   std::stringstream err;
41 
42   \textcolor{comment}{// Default optimizer}
43   \textcolor{keyword}{auto}&& opt = \hyperlink{namespacelbann_1_1proto_af85d2b9f1e986bbab4feccfaa19c9960}{construct\_optimizer}(\hyperlink{file__io_8cpp_ab048c6f9fcbcfaa57ce68b00263dbebe}{comm}, proto\_opt);
44 
45   \textcolor{comment}{// Construct model}
46   \textcolor{keyword}{const} \textcolor{keyword}{auto}& type = proto\_model.name();
47   \textcolor{keyword}{const} \textcolor{keyword}{auto}& mini\_batch\_size = proto\_model.mini\_batch\_size();
48   \textcolor{keywordflow}{if} (type == \textcolor{stringliteral}{"sequential\_model"} || type == \textcolor{stringliteral}{""}) \{
49     \textcolor{keywordflow}{return} \textcolor{keyword}{new} sequential\_model(\hyperlink{file__io_8cpp_ab048c6f9fcbcfaa57ce68b00263dbebe}{comm}, mini\_batch\_size, obj, opt);
50   \}
51   \textcolor{keywordflow}{if} (type == \textcolor{stringliteral}{"directed\_acyclic\_graph\_model"}) \{
52     \textcolor{keywordflow}{return} \textcolor{keyword}{new} directed\_acyclic\_graph\_model(\hyperlink{file__io_8cpp_ab048c6f9fcbcfaa57ce68b00263dbebe}{comm}, mini\_batch\_size, obj, opt);
53   \}
54   \textcolor{keywordflow}{if} (type == \textcolor{stringliteral}{"recurrent\_model"}) \{
55     \textcolor{keyword}{const} \textcolor{keyword}{auto}& params = proto\_model.recurrent();
56     \textcolor{keywordflow}{return} \textcolor{keyword}{new} recurrent\_model(\hyperlink{file__io_8cpp_ab048c6f9fcbcfaa57ce68b00263dbebe}{comm},
57                                mini\_batch\_size,
58                                obj,
59                                opt,
60                                params.unroll\_depth());
61   \}
62   \textcolor{keywordflow}{if} (type == \textcolor{stringliteral}{"siamese\_model"}) \{
63     \textcolor{keyword}{const} \textcolor{keyword}{auto}& params = proto\_model.siamese();
64     \textcolor{keywordflow}{return} \textcolor{keyword}{new} siamese\_model(\hyperlink{file__io_8cpp_ab048c6f9fcbcfaa57ce68b00263dbebe}{comm},
65                              mini\_batch\_size,
66                              obj,
67                              opt,
68                              params.num\_heads());
69   \}
70 
71   \textcolor{comment}{// Throw error if model type is not supported}
72   err << \textcolor{stringliteral}{"unknown model type ("} << type << \textcolor{stringliteral}{")"};
73   \hyperlink{base_8hpp_a80b1d707117e968a6951b7222e4b2b87}{LBANN\_ERROR}(err.str());
74   \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
75 
76 \}
\end{DoxyCode}
Here is the call graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacelbann_1_1proto_1_1anonymous__namespace_02model__factory_8cpp_03_a6a08f0b26d015824ef28ddbb66b6d4c0_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacelbann_1_1proto_1_1anonymous__namespace_02model__factory_8cpp_03_a6a08f0b26d015824ef28ddbb66b6d4c0_icgraph}
\end{center}
\end{figure}
